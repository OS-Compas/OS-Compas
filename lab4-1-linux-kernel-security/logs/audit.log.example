
## ğŸ“ logs/ ç›®å½•

### 14. **logs/audit.log.example**

```log
# Linuxå®¡è®¡æ—¥å¿—ç¤ºä¾‹
# ç”¨äºå®éªŒ4.1çš„SELinuxå®¡è®¡åˆ†æ
# å®é™…æ–‡ä»¶è·¯å¾„ï¼š/var/log/audit/audit.log

# ============================================
# å®¡è®¡æ—¥å¿—å¤´ä¿¡æ¯
# ============================================
type=DAEMON_START msg=audit(1642500000.000:1): op=start ver=2.8.0 format=enriched kernel=5.15.0-custom auid=4294967295 pid=1234 uid=0 ses=4294967295 subj=system_u:system_r:auditd_t:s0 res=success
type=CONFIG_CHANGE msg=audit(1642500001.000:2): auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 op=add_rule key="selinux_test" list=4 res=1

# ============================================
# SELinux AVCæ‹’ç»ç¤ºä¾‹ï¼ˆå¼ºåˆ¶æ¨¡å¼ä¸‹çš„æ‹’ç»ï¼‰
# ============================================
type=AVC msg=audit(1642500100.000:100): avc:  denied  { write } for  pid=5678 comm="test_program" name="shadow" dev="sda1" ino=123456 scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=system_u:object_r:shadow_t:s0 tclass=file permissive=0

type=SYSCALL msg=audit(1642500100.000:100): arch=c000003e syscall=2 success=no exit=-13 a0=7ffc12345678 a1=241 a2=1b6 a3=7ffc12345678 items=0 ppid=5677 pid=5678 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=1 comm="test_program" exe="/usr/bin/test_program" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="selinux_test"

# ============================================
# SELinux AVCå…è®¸ç¤ºä¾‹ï¼ˆè®¸å¯æ¨¡å¼ä¸‹çš„å…è®¸ï¼‰
# ============================================
type=AVC msg=audit(1642500200.000:200): avc:  granted  { write } for  pid=6789 comm="test_program" name="testfile" dev="sda1" ino=654321 scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:user_home_t:s0 tclass=file permissive=1

# ============================================
# ç”¨æˆ·ç™»å½•å®¡è®¡
# ============================================
type=USER_LOGIN msg=audit(1642500300.000:300): pid=7890 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:sshd_t:s0-s0:c0.c1023 msg='op=login acct="root" exe="/usr/sbin/sshd" hostname=? addr=192.168.1.100 terminal=ssh res=success'

type=USER_AUTH msg=audit(1642500301.000:301): pid=7890 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:sshd_t:s0-s0:c0.c1023 msg='op=password acct="root" exe="/usr/sbin/sshd" hostname=192.168.1.100 addr=192.168.1.100 terminal=ssh res=success'

# ============================================
# ç‰¹æƒå‘½ä»¤æ‰§è¡Œå®¡è®¡
# ============================================
type=USER_CMD msg=audit(1642500400.000:400): pid=8901 uid=1000 auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 msg='cwd="/home/user" cmd="sudo ls -la" terminal=pts0 res=success'

type=USER_START msg=audit(1642500401.000:401): pid=8902 uid=0 auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 msg='op=PAM:session_open grantors=pam_limits,pam_unix,pam_permit,sss acct="root" exe="/usr/bin/sudo" hostname=? addr=? terminal=/dev/pts/0 res=success'

# ============================================
# æ–‡ä»¶ç³»ç»Ÿæ“ä½œå®¡è®¡
# ============================================
type=PATH msg=audit(1642500500.000:500): item=0 name="/etc/passwd" inode=123457 dev=08:01 mode=0100644 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:etc_t:s0 nametype=NORMAL cap_fp=0 cap_fi=0 cap_fe=0 cap_fver=0 cap_frootid=0
type=CWD msg=audit(1642500500.000:500):  cwd="/home/user"
type=SYSCALL msg=audit(1642500500.000:500): arch=c000003e syscall=257 success=yes exit=3 a0=ffffff9c a1=7ffd12345678 a2=0 a3=0 items=1 ppid=9012 pid=9013 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=1 comm="cat" exe="/usr/bin/cat" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="file_access"

# ============================================
# ç½‘ç»œè¿æ¥å®¡è®¡
# ============================================
type=SOCKADDR msg=audit(1642500600.000:600): saddr=020000507F0000010019000000000000
type=SYSCALL msg=audit(1642500600.000:600): arch=c000003e syscall=42 success=yes exit=0 a0=3 a1=7ffd12345678 a2=10 a3=7ffd12345678 items=0 ppid=1234 pid=1235 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=1 comm="curl" exe="/usr/bin/curl" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="network_connect"

# ============================================
# SELinuxç­–ç•¥åŠ è½½å®¡è®¡
# ============================================
type=MAC_POLICY_LOAD msg=audit(1642500700.000:700): auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 op=load_policy lsm=selinux res=1
type=MAC_CONFIG_CHANGE msg=audit(1642500701.000:701): auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 op=setenforce lsm=selinux enforcing=0 old-enforcing=1 new-enforcing=0 res=1

# ============================================
# å®éªŒç›¸å…³å®¡è®¡äº‹ä»¶
# ============================================
# å†…æ ¸æ¨¡å—åŠ è½½æµ‹è¯•
type=AVC msg=audit(1642500800.000:800): avc:  denied  { module_load } for  pid=2345 comm="insmod" path="/root/kasan_module.ko" dev="sda1" ino=789012 scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=system_u:object_r:modules_object_t:s0 tclass=system permissive=1

type=SYSCALL msg=audit(1642500800.000:800): arch=c000003e syscall=175 success=yes exit=0 a0=7ffd12345678 a1=0 a2=0 a3=0 items=0 ppid=2344 pid=2345 auid=1000 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts0 ses=1 comm="insmod" exe="/usr/sbin/insmod" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key=(null)

# æµ‹è¯•æ–‡ä»¶åˆ›å»º
type=AVC msg=audit(1642500900.000:900): avc:  granted  { create } for  pid=3456 comm="touch" name="selinux_test.txt" scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:user_home_t:s0 tclass=file permissive=1

type=PATH msg=audit(1642500900.000:900): item=0 name="selinux_test.txt" inode=890123 dev=08:01 mode=0100644 ouid=1000 ogid=1000 rdev=00:00 obj=unconfined_u:object_r:user_home_t:s0 nametype=CREATE cap_fp=0 cap_fi=0 cap_fe=0 cap_fver=0 cap_frootid=0

# ============================================
# KASANå†…å­˜é”™è¯¯æ£€æµ‹ï¼ˆå¦‚æœé…ç½®äº†å®¡è®¡ï¼‰
# ============================================
type=ANOM_ABEND msg=audit(1642501000.000:1000): auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 op=KASAN-detected pid=4567 comm="test_program" reason="slab-out-of-bounds" addr=0xffff888012345678 bytes=1

# ============================================
# ç³»ç»Ÿè°ƒç”¨å¤±è´¥å®¡è®¡
# ============================================
type=SYSCALL msg=audit(1642501100.000:1100): arch=c000003e syscall=21 success=no exit=-13 a0=7ffd12345678 a1=0 a2=0 a3=0 items=0 ppid=5678 pid=5679 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=1 comm="test_program" exe="/usr/bin/test_program" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key=(null)

# ============================================
# å®¡è®¡è§„åˆ™å˜æ›´
# ============================================
type=CONFIG_CHANGE msg=audit(1642501200.000:1200): auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 op=add_rule key="kernel_lab" list=4 res=1
type=CONFIG_CHANGE msg=audit(1642501201.000:1201): auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 op=remove_rule key="old_key" list=4 res=1

# ============================================
# è¿›ç¨‹æ‰§è¡Œå®¡è®¡
# ============================================
type=EXECVE msg=audit(1642501300.000:1300): argc=3 a0="ls" a1="-la" a2="/etc/selinux/"
type=PROCTITLE msg=audit(1642501300.000:1300): proctitle=6C73002D6C61002F6574632F73656C696E75782F

# ============================================
# ç”¨æˆ·æ ‡è¯†å˜æ›´å®¡è®¡
# ============================================
type=USER_ACCT msg=audit(1642501400.000:1400): pid=6789 uid=0 auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 msg='op=PAM:accounting grantors=pam_unix,pam_permit,sss acct="user" exe="/usr/bin/sudo" hostname=? addr=? terminal=/dev/pts/0 res=success'
type=USER_AUTH msg=audit(1642501401.000:1401): pid=6789 uid=0 auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 msg='op=PAM:authentication grantors=pam_unix,pam_permit,sss acct="user" exe="/usr/bin/sudo" hostname=? addr=? terminal=/dev/pts/0 res=success'

# ============================================
# å®¡è®¡æœåŠ¡çŠ¶æ€å˜æ›´
# ============================================
type=DAEMON_END msg=audit(1642501500.000:1500): op=terminate auid=1000 pid=7890 res=success
type=DAEMON_START msg=audit(1642501501.000:1501): op=start ver=2.8.0 format=enriched kernel=5.15.0-custom auid=4294967295 pid=7891 uid=0 ses=4294967295 subj=system_u:system_r:auditd_t:s0 res=success

# ============================================
# SELinuxæµ‹è¯•ç¨‹åºç‰¹å®šå®¡è®¡
# ============================================
# æµ‹è¯•ç¨‹åºå°è¯•è®¿é—®æ•æ„Ÿæ–‡ä»¶
type=AVC msg=audit(1642501600.000:1600): avc:  denied  { read } for  pid=12345 comm="selinux_test" name="shadow" dev="sda1" ino=123456 scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=system_u:object_r:shadow_t:s0 tclass=file permissive=0

# æµ‹è¯•ç¨‹åºåˆ›å»ºæµ‹è¯•æ–‡ä»¶
type=AVC msg=audit(1642501601.000:1601): avc:  granted  { create write } for  pid=12345 comm="selinux_test" name="testfile.txt" scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:user_home_t:s0 tclass=file permissive=1

# æµ‹è¯•ç¨‹åºæ£€æŸ¥å®¡è®¡æ—¥å¿—
type=AVC msg=audit(1642501602.000:1602): avc:  granted  { read } for  pid=12345 comm="selinux_test" name="audit.log" dev="sda1" ino=654321 scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 tcontext=system_u:object_r:auditd_log_t:s0 tclass=file permissive=1

# ============================================
# å®éªŒå®Œæˆæ ‡è®°
# ============================================
type=USER_END msg=audit(1642501700.000:1700): pid=12345 uid=1000 auid=1000 ses=1 subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 msg='op=PAM:session_close grantors=pam_limits,pam_unix,pam_permit,sss acct="user" exe="/usr/bin/bash" hostname=? addr=? terminal=/dev/pts/0 res=success'

# ============================================
# æ—¥å¿—å­—æ®µè¯´æ˜
# ============================================
# å¸¸è§å­—æ®µå«ä¹‰ï¼š
# type      - äº‹ä»¶ç±»å‹ (AVC, SYSCALL, USER_LOGINç­‰)
# msg=audit(æ—¶é—´æˆ³:åºåˆ—å·) - å”¯ä¸€æ ‡è¯†
# avc: denied/granted - SELinuxè®¿é—®æ§åˆ¶å†³ç­–
# pid      - è¿›ç¨‹ID
# comm     - å‘½ä»¤å
# scontext - æºå®‰å…¨ä¸Šä¸‹æ–‡ (æ‰§è¡Œè€…)
# tcontext - ç›®æ ‡å®‰å…¨ä¸Šä¸‹æ–‡ (è¢«è®¿é—®å¯¹è±¡)
# tclass   - ç›®æ ‡ç±»åˆ« (file, dir, processç­‰)
# permissive - æ˜¯å¦åœ¨è®¸å¯æ¨¡å¼ (0=å¼ºåˆ¶, 1=è®¸å¯)
# success  - ç³»ç»Ÿè°ƒç”¨æ˜¯å¦æˆåŠŸ
# auid     - å®¡è®¡ç”¨æˆ·ID (ç™»å½•æ—¶çš„åŸå§‹ç”¨æˆ·)
# uid/gid  - å®é™…ç”¨æˆ·/ç»„ID
# exe      - å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
# key      - å®¡è®¡è§„åˆ™é”®å€¼
# res      - æ“ä½œç»“æœ

# ============================================
# ä½¿ç”¨è¿™äº›æ—¥å¿—è¿›è¡Œåˆ†æçš„å·¥å…·
# ============================================
# 1. æœç´¢ç‰¹å®šç±»å‹çš„å®¡è®¡äº‹ä»¶
#    ausearch -m avc -ts today
#
# 2. æœç´¢ç‰¹å®šç¨‹åºçš„å®¡è®¡äº‹ä»¶
#    ausearch -c selinux_test
#
# 3. ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
#    aureport --avc
#    aureport --summary
#
# 4. åˆ†æSELinuxæ‹’ç»
#    sealert -a /var/log/audit/audit.log
#
# 5. å®æ—¶ç›‘æ§å®¡è®¡æ—¥å¿—
#    tail -f /var/log/audit/audit.log | audit2allow