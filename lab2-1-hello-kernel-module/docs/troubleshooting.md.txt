å®éªŒ2.1 æ•…éšœæ’é™¤æŒ‡å—
ğŸš¨ å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨
1. ç¼–è¯‘é—®é¢˜
é—®é¢˜ï¼šmake: /lib/modules/xxx/build: No such file or directory

bash
# è§£å†³æ–¹æ¡ˆï¼šå®‰è£…å†…æ ¸å¤´æ–‡ä»¶
sudo apt update
sudo apt install linux-headers-$(uname -r)

# éªŒè¯å®‰è£…
ls /lib/modules/$(uname -r)/build
é—®é¢˜ï¼šMakefile æŠ¥é”™

bash
# ç¡®ä¿å®‰è£…äº†ç¼–è¯‘å·¥å…·
sudo apt install build-essential

# æ¸…ç†åé‡æ–°ç¼–è¯‘
make clean && make
2. æ¨¡å—åŠ è½½é—®é¢˜
é—®é¢˜ï¼šOperation not permitted

bash
# ä½¿ç”¨sudoæƒé™
sudo insmod hello.ko
é—®é¢˜ï¼šInvalid parameters

bash
# æ£€æŸ¥å‚æ•°æ ¼å¼
sudo insmod hello.ko whom="Student" howmany=3 debug=1

# æŸ¥çœ‹æ­£ç¡®çš„å‚æ•°åå’Œç±»å‹
modinfo hello.ko
é—®é¢˜ï¼šFile exists

bash
# æ¨¡å—å·²åŠ è½½ï¼Œå…ˆå¸è½½
sudo rmmod hello

# æ£€æŸ¥æ¨¡å—çŠ¶æ€
lsmod | grep hello
3. çœ‹ä¸åˆ°è¾“å‡ºæ¶ˆæ¯
é—®é¢˜ï¼šdmesg æ²¡æœ‰æ˜¾ç¤ºé—®å€™ä¿¡æ¯

bash
# æŸ¥çœ‹æ‰€æœ‰çº§åˆ«çš„æ¶ˆæ¯
dmesg | tail -20

# æˆ–è€…åªçœ‹infoåŠä»¥ä¸Šçº§åˆ«
dmesg -l info,notice,warn,err | tail -10

# å®æ—¶ç›‘æ§
sudo dmesg -w
é—®é¢˜ï¼šè°ƒè¯•æ¶ˆæ¯ä¸æ˜¾ç¤º

bash
# åŠ è½½æ—¶å¯ç”¨debugå‚æ•°
sudo insmod hello.ko debug=1

# æˆ–è€…è°ƒæ•´å†…æ ¸æ—¥å¿—çº§åˆ«
echo 8 > /proc/sys/kernel/printk
4. æ¨¡å—å¸è½½é—®é¢˜
é—®é¢˜ï¼šModule hello is not currently loaded

bash
# æ£€æŸ¥æ¨¡å—æ˜¯å¦çœŸçš„åŠ è½½äº†
lsmod | grep hello
é—®é¢˜ï¼šModule hello is in use

bash
# æŸ¥çœ‹ä½¿ç”¨è¯¥æ¨¡å—çš„è¿›ç¨‹
sudo lsof | grep hello

# æˆ–è€…é‡å¯ç³»ç»Ÿï¼ˆæç«¯æƒ…å†µï¼‰
sudo reboot
ğŸ”§ ç¯å¢ƒæ£€æŸ¥æ¸…å•
å¿«é€ŸéªŒè¯è„šæœ¬
bash
#!/bin/bash
echo "=== ç¯å¢ƒæ£€æŸ¥ ==="
echo "1. å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
echo "2. å¤´æ–‡ä»¶: $(ls /lib/modules/$(uname -r)/build 2>/dev/null || echo 'æœªæ‰¾åˆ°')"
echo "3. ç¼–è¯‘å™¨: $(gcc --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
echo "4. Makeå·¥å…·: $(make --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
echo "5. å½“å‰ç”¨æˆ·: $(whoami)"
echo "=== æ£€æŸ¥å®Œæˆ ==="
åˆ†æ­¥éªŒè¯
bash
# æ­¥éª¤1ï¼šæ£€æŸ¥å†…æ ¸å¤´æ–‡ä»¶
uname -r
ls /lib/modules/$(uname -r)/build

# æ­¥éª¤2ï¼šæ£€æŸ¥ç¼–è¯‘å·¥å…·
gcc --version
make --version

# æ­¥éª¤3ï¼šæ£€æŸ¥æƒé™
groups | grep sudo

# æ­¥éª¤4ï¼šæ£€æŸ¥æ¨¡å—å·¥å…·
which insmod
which rmmod
which modinfo
ğŸ› è°ƒè¯•æŠ€å·§
1. è¯¦ç»†æ„å»ºä¿¡æ¯
bash
# æ˜¾ç¤ºè¯¦ç»†ç¼–è¯‘è¿‡ç¨‹
make V=1

# å¹¶è¡Œç¼–è¯‘ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
make -j4
2. æ¨¡å—ä¿¡æ¯æ£€æŸ¥
bash
# æŸ¥çœ‹æ¨¡å—è¯¦ç»†ä¿¡æ¯
modinfo hello.ko

# æ£€æŸ¥æ¨¡å—ä¾èµ–
modprobe --show-depends hello

# æŸ¥çœ‹å·²åŠ è½½æ¨¡å—çš„å‚æ•°
cat /sys/module/hello/parameters/* 2>/dev/null || echo "æ¨¡å—æœªåŠ è½½"
3. ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥
bash
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -xe

# æŸ¥çœ‹å†…æ ¸ç›¸å…³æ—¥å¿—
sudo journalctl -k --since "5 minutes ago"

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
dmesg | grep -i error
ğŸ’» å‘è¡Œç‰ˆç‰¹å®šé—®é¢˜
Ubuntu/Debian
bash
# å¦‚æœæ ‡å‡†æ–¹æ³•æ— æ•ˆ
sudo apt install linux-headers-generic
sudo apt install build-essential

# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade
CentOS/RHEL
bash
# å®‰è£…å¼€å‘å·¥å…·
sudo yum groupinstall "Development Tools"
sudo yum install kernel-devel-$(uname -r)

# æˆ–è€…ä½¿ç”¨dnf
sudo dnf install kernel-devel-$(uname -r)
Arch Linux
bash
# å®‰è£…å†…æ ¸å¤´æ–‡ä»¶
sudo pacman -S linux-headers

# å¦‚æœä½¿ç”¨LTSå†…æ ¸
sudo pacman -S linux-lts-headers
ğŸ›¡ï¸ ç´§æ€¥æ¢å¤
æ¨¡å—å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
bash
# ç«‹å³å¸è½½æ¨¡å—
sudo rmmod hello

# å¦‚æœæ— æ³•å¸è½½ï¼Œé‡å¯ç³»ç»Ÿ
sudo reboot

# é˜²æ­¢æ¨¡å—è‡ªåŠ¨åŠ è½½
echo "blacklist hello" | sudo tee /etc/modprobe.d/hello-blacklist.conf
å†…æ ¸å´©æºƒï¼ˆç½•è§æƒ…å†µï¼‰
å¼ºåˆ¶é‡å¯ç³»ç»Ÿ

å¯åŠ¨æ—¶é€‰æ‹©æ¢å¤æ¨¡å¼

åˆ é™¤æˆ–é‡å‘½åæœ‰é—®é¢˜çš„æ¨¡å—æ–‡ä»¶

ğŸ“‹ æ ‡å‡†æ“ä½œæµç¨‹
æˆåŠŸçš„å·¥ä½œæµç¨‹
bash
# 1. è¿›å…¥æºç ç›®å½•
cd src

# 2. ç¼–è¯‘æ¨¡å—
make

# 3. æ£€æŸ¥ç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶
ls -la hello.ko

# 4. æŸ¥çœ‹æ¨¡å—ä¿¡æ¯
modinfo hello.ko

# 5. åŠ è½½æ¨¡å—ï¼ˆå¸¦å‚æ•°ï¼‰
sudo insmod hello.ko whom="Linux" howmany=2 debug=1

# 6. éªŒè¯åŠ è½½
lsmod | grep hello

# 7. æŸ¥çœ‹è¾“å‡º
dmesg | tail -10

# 8. å¸è½½æ¨¡å—
sudo rmmod hello

# 9. éªŒè¯å¸è½½
dmesg | tail -5
â“ è·å–æ›´å¤šå¸®åŠ©
æä¾›çš„ä¿¡æ¯
å½“å¯»æ±‚å¸®åŠ©æ—¶ï¼Œè¯·æä¾›ï¼š

æ“ä½œç³»ç»Ÿå’Œç‰ˆæœ¬

å†…æ ¸ç‰ˆæœ¬ (uname -r)

å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

å·²ç»å°è¯•çš„è§£å†³æ­¥éª¤

æœ‰ç”¨çš„è¯Šæ–­å‘½ä»¤
bash
# ç³»ç»Ÿä¿¡æ¯
cat /etc/os-release
uname -a

# æ¨¡å—ç›¸å…³ä¿¡æ¯
lsmod
dmesg | tail -30

# æ„å»ºç¯å¢ƒ
make --version
gcc --version
âœ… å¿«é€Ÿæµ‹è¯•è„šæœ¬
åˆ›å»ºä¸€ä¸ªæµ‹è¯•è„šæœ¬ quick_test.shï¼š

bash
#!/bin/bash
echo "å¿«é€Ÿæµ‹è¯•å®éªŒ2.1..."
make clean
make
sudo rmmod hello 2>/dev/null
sudo insmod hello.ko whom="Test" howmany=1 debug=1
dmesg | tail -5
sudo rmmod hello
echo "æµ‹è¯•å®Œæˆï¼"