#!/bin/bash

# unload_module.sh - 内核模块卸载脚本
# 用于安全地卸载hello内核模块

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MODULE_NAME="hello"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 日志函数
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 显示使用说明
show_usage() {
    echo "用法: $0 [选项]"
    echo ""
    echo "选项:"
    echo "  -h, --help          显示此帮助信息"
    echo "  -m, --module NAME   指定要卸载的模块名 (默认: hello)"
    echo "  -f, --force         强制卸载模块"
    echo "  -v, --verbose       显示详细输出"
    echo "  -c, --check-only    只检查模块状态，不实际卸载"
    echo ""
    echo "示例:"
    echo "  $0                  卸载hello模块"
    echo "  $0 -m hello_param   卸载hello_param模块"
    echo "  $0 -f               强制卸载模块"
    echo "  $0 -c               只检查模块状态"
}

# 检查模块是否加载
check_module_loaded() {
    local module=$1
    if lsmod | grep -q "^${module} "; then
        return 0  # 模块已加载
    else
        return 1  # 模块未加载
    fi
}

# 检查模块是否正在被使用
check_module_in_use() {
    local module=$1
    local use_count=$(cat /proc/modules | grep "^${module} " | awk '{print $3}')
    if [ "$use_count" != "0" ]; then
        return 0  # 模块正在被使用
    else
        return 1  # 模块未被使用
    fi
}

# 获取模块的使用计数
get_module_use_count() {
    local module=$1
    cat /proc/modules | grep "^${module} " | awk '{print $3}' 2>/dev/null || echo "0"
}

# 显示模块信息
show_module_info() {
    local module=$1
    log_info "模块信息:"
    echo "  名称: $module"
    echo "  使用计数: $(get_module_use_count $module)"
    
    # 显示模块参数（如果可用）
    if [ -d "/sys/module/$module/parameters" ]; then
        echo "  参数:"
        for param in /sys/module/$module/parameters/*; do
            if [ -f "$param" ]; then
                param_name=$(basename $param)
                param_value=$(cat $param 2>/dev/null || echo "N/A")
                echo "    $param_name = $param_value"
            fi
        done
    fi
}

# 安全卸载模块
safe_unload_module() {
    local module=$1
    local force=$2
    local verbose=$3
    
    if [ "$verbose" = "true" ]; then
        log_info "开始卸载模块: $module"
    fi
    
    # 检查模块是否正在被使用
    if check_module_in_use "$module"; then
        local use_count=$(get_module_use_count "$module")
        if [ "$force" = "true" ]; then
            log_warning "模块 $module 正在被 $use_count 个进程使用，强制卸载..."
        else
            log_error "模块 $module 正在被 $use_count 个进程使用，无法卸载"
            log_info "可以使用以下命令查看使用情况:"
            echo "  sudo lsof | grep $module"
            echo " 或者使用 -f 选项强制卸载"
            return 1
        fi
    fi
    
    # 执行卸载
    if [ "$verbose" = "true" ]; then
        log_info "执行: sudo rmmod $module"
    fi
    
    if sudo rmmod "$module"; then
        log_success "模块 $module 卸载成功"
        
        # 显示卸载后的内核消息
        if [ "$verbose" = "true" ]; then
            log_info "最近的内核消息:"
            dmesg | tail -3 | grep -E "(Goodbye|unloaded|$module)"
        fi
        return 0
    else
        log_error "模块 $module 卸载失败"
        
        # 显示详细错误信息
        dmesg | tail -5 | grep -E "(error|fail|$module)" | tail -3
        return 1
    fi
}

# 主函数
main() {
    local module_name="$MODULE_NAME"
    local force_unload=false
    local verbose=false
    local check_only=false
    
    # 解析命令行参数
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -m|--module)
                module_name="$2"
                shift 2
                ;;
            -f|--force)
                force_unload=true
                shift
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            -c|--check-only)
                check_only=true
                shift
                ;;
            *)
                log_error "未知选项: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # 显示脚本标题
    echo -e "${BLUE}=== 内核模块卸载工具 ===${NC}"
    echo "目标模块: $module_name"
    echo ""
    
    # 检查模块是否存在
    if ! check_module_loaded "$module_name"; then
        log_warning "模块 $module_name 未加载"
        exit 0
    fi
    
    # 显示模块当前状态
    show_module_info "$module_name"
    echo ""
    
    # 如果只是检查，则退出
    if [ "$check_only" = "true" ]; then
        log_info "检查完成，模块当前已加载"
        exit 0
    fi
    
    # 确认卸载（除非强制模式）
    if [ "$force_unload" != "true" ]; then
        read -p "确定要卸载模块 $module_name 吗？(y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "取消卸载操作"
            exit 0
        fi
    fi
    
    # 执行卸载
    if safe_unload_module "$module_name" "$force_unload" "$verbose"; then
        # 验证卸载结果
        if check_module_loaded "$module_name"; then
            log_error "模块卸载后仍然存在，可能卸载不彻底"
            exit 1
        else
            log_success "验证: 模块 $module_name 已完全卸载"
            exit 0
        fi
    else
        exit 1
    fi
}

# 脚本入口
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi