/**
 * hello.c - Linux内核模块示例
 * 
 * 展示如何编写、编译、加载和卸载一个简单的内核模块
 * 支持模块参数传递和动态调试输出
 */

#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/moduleparam.h>

/* 模块信息 */
MODULE_LICENSE("GPL");
MODULE_AUTHOR("OS-Lab-Team");
MODULE_DESCRIPTION("A simple hello world kernel module with parameters");
MODULE_VERSION("1.0");

/* 模块参数定义 */
static char *whom = "world";
module_param(whom, charp, 0644);
MODULE_PARM_DESC(whom, "Recipient of the greeting (default: world)");

static int howmany = 1;
module_param(howmany, int, 0644);
MODULE_PARM_DESC(howmany, "Number of greetings (default: 1)");

static int debug = 0;
module_param(debug, int, 0644);
MODULE_PARM_DESC(debug, "Enable debug output (default: 0)");

#define DEBUG_PRINT(fmt, args...) \
    do { \
        if (debug) \
            printk(KERN_DEBUG "HELLO_DEBUG: " fmt, ##args); \
    } while (0)

/**
 * 模块初始化函数
 * 在模块加载时调用
 */
static int __init hello_init(void)
{
    int i;
    
    DEBUG_PRINT("Initializing hello module\n");
    DEBUG_PRINT("whom=%s, howmany=%d\n", whom, howmany);
    
    /* 参数验证 */
    if (howmany < 0 || howmany > 10) {
        printk(KERN_ERR "hello: howmany must be between 0 and 10\n");
        return -EINVAL;
    }
    
    if (whom == NULL || strlen(whom) == 0) {
        printk(KERN_ERR "hello: whom cannot be empty\n");
        return -EINVAL;
    }
    
    /* 输出问候信息 */
    for (i = 0; i < howmany; i++) {
        printk(KERN_INFO "Hello, %s! Greeting #%d\n", whom, i + 1);
    }
    
    printk(KERN_INFO "hello: Module loaded successfully\n");
    return 0;
}

/**
 * 模块清理函数
 * 在模块卸载时调用
 */
static void __exit hello_exit(void)
{
    DEBUG_PRINT("Cleaning up hello module\n");
    printk(KERN_INFO "Goodbye, %s! The hello module has been unloaded.\n", whom);
    printk(KERN_INFO "hello: Module unloaded successfully\n");
}

/* 注册模块初始化和清理函数 */
module_init(hello_init);
module_exit(hello_exit);