# Linux内核模块Makefile
# 用于构建hello world内核模块

obj-m += hello.o

# 内核构建目录
KDIR ?= /lib/modules/$(shell uname -r)/build

# 当前模块目录
PWD := $(shell pwd)

# 默认构建目标
default:
	@echo "Building hello kernel module..."
	@echo "Kernel directory: $(KDIR)"
	@echo "Current directory: $(PWD)"
	$(MAKE) -C $(KDIR) M=$(PWD) modules

# 清理构建产物
clean:
	$(MAKE) -C $(KDIR) M=$(PWD) clean
	@echo "Clean completed"

# 安装模块
install: default
	sudo insmod hello.ko

# 卸载模块
uninstall:
	sudo rmmod hello

# 加载模块（带默认参数）
load:
	sudo insmod hello.ko whom="OSLab" howmany=3 debug=1

# 重新加载模块
reload: uninstall install

# 显示模块信息
info:
	modinfo hello.ko

# 检查模块状态
status:
	@lsmod | grep hello || echo "Module not loaded"

# 查看内核日志
logs:
	dmesg | tail -20

# 构建并测试
test: default load
	sleep 1
	@echo "=== Module status ==="
	@make status
	@echo "=== Recent kernel messages ==="
	@dmesg | tail -10
	sleep 2
	make uninstall

.PHONY: default clean install uninstall load reload info status logs test