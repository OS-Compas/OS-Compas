```markdown
# eBPF与bpftrace理论基础

## eBPF架构概述

### 什么是eBPF？
eBPF是一种革命性的内核技术，允许用户在不修改内核源代码或加载内核模块的情况下，安全、高效地在内核中运行沙盒程序。

### eBPF工作流程
1. **编写程序**：用C或bpftrace编写eBPF程序
2. **编译验证**：通过LLVM编译为eBPF字节码，验证器检查安全性
3. **即时编译**：内核将字节码编译为本地机器码
4. **附加到事件**：将程序附加到探针点（kprobe、tracepoint等）
5. **执行和数据收集**：事件触发时执行程序，通过映射输出数据

### eBPF安全机制
- **验证器（Verifier）**：静态分析字节码，确保程序安全
  - 有限循环（必须可证明会终止）
  - 有限栈大小（512字节）
  - 受控的内存访问
  - 无空指针解引用
- **特权限制**：通常需要root权限
- **资源限制**：指令数、映射大小、运行时间限制

## bpftrace语言基础

### 探针语法
探针类型:探点名 [过滤器] { 动作 }

text

### 探针类型
| 类型 | 描述 | 示例 |
|------|------|------|
| `kprobe` | 内核函数入口 | `kprobe:vfs_read` |
| `kretprobe` | 内核函数返回 | `kretprobe:vfs_read` |
| `tracepoint` | 静态跟踪点 | `tracepoint:syscalls:sys_enter_open` |
| `uprobe` | 用户函数入口 | `uprobe:/bin/bash:readline` |
| `interval` | 定时触发 | `interval:s:5` |
| `BEGIN/END` | 开始/结束 | `BEGIN { printf("开始\n"); }` |

### 内置变量
| 变量 | 描述 |
|------|------|
| `pid` | 进程ID |
| `tid` | 线程ID |
| `comm` | 进程名 |
| `nsecs` | 纳秒时间戳 |
| `kstack` | 内核栈 |
| `ustack` | 用户栈 |
| `arg0-argN` | 函数参数 |

### 内置函数
| 函数 | 描述 |
|------|------|
| `printf()` | 格式化输出 |
| `str()` | 转换指针为字符串 |
| `hist()` | 生成直方图 |
| `count()` | 计数 |
| `sum()` | 求和 |
| `avg()` | 平均值 |
| `clear()` | 清除映射 |

## kprobe vs tracepoint

### kprobe（动态探针）
**优点：**
- 可以跟踪几乎任何内核函数
- 不需要内核预先支持
- 可以获取函数参数和返回值

**缺点：**
- 依赖于内核符号，可能随版本变化
- 性能开销相对较大
- 可能不够稳定

### tracepoint（静态跟踪点）
**优点：**
- 内核稳定ABI，版本兼容性好
- 性能开销小
- 参数类型和意义明确

**缺点：**
- 需要内核预先定义跟踪点
- 跟踪点数量有限
- 无法跟踪任意函数

## 性能考虑

### 开销分析
- **最小化开销**：使用过滤器减少事件触发频率
- **高效数据结构**：使用eBPF映射而不是printk
- **采样**：每秒只处理部分事件
- **聚合**：在内核中聚合数据，减少用户空间传输

### 最佳实践
1. 始终在生产环境测试性能影响
2. 使用采样减少事件量
3. 避免在热点路径上附加复杂程序
4. 定期检查系统负载

## 调试技巧

### 常见问题排查
1. **权限不足**：eBPF需要root权限或CAP_BPF能力
2. **验证器拒绝**：程序太复杂或包含不安全操作
3. **缺少符号**：安装内核调试符号包
4. **探针不存在**：检查内核版本和配置

### 调试命令
```bash
# 查看可用的tracepoint
sudo bpftrace -l 'tracepoint:syscalls:*'

# 查看可用的kprobe
sudo bpftrace -l 'kprobe:*' | head -20

# 查看程序是否加载
sudo bpftool prog list

# 查看映射
sudo bpftool map list