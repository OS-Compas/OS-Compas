
### 2. é«˜çº§è·Ÿè¸ªç¤ºä¾‹

**examples/advanced_tracing.bt**

```bash
#!/usr/bin/env bpftrace

/*
 * advanced_tracing.bt
 * é«˜çº§ç»¼åˆè·Ÿè¸ªç¤ºä¾‹ï¼šç³»ç»Ÿæ€§èƒ½åˆ†æä»ªè¡¨æ¿
 * 
 * åŠŸèƒ½ï¼š
 * 1. å®æ—¶CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç›‘æ§
 * 2. è¿›ç¨‹çº§èµ„æºä½¿ç”¨ç»Ÿè®¡
 * 3. å¼‚å¸¸æ£€æµ‹å’Œå‘Šè­¦
 * 4. å†å²è¶‹åŠ¿åˆ†æ
 * 5. äº¤äº’å¼æ§åˆ¶é¢æ¿
 */

#include <linux/sched.h>

// å…¨å±€é…ç½®
BEGIN
{
    printf("\033[2J\033[H");  // æ¸…å±
    printf("âš¡ eBPF é«˜çº§ç³»ç»Ÿè·Ÿè¸ªä»ªè¡¨æ¿\n");
    printf("===============================\n");
    printf("å¯åŠ¨æ—¶é—´: %s\n", strftime("%Y-%m-%d %H:%M:%S", nsecs));
    printf("å†…æ ¸ç‰ˆæœ¬: %s\n", kversion);
    printf("è¿è¡Œæ¨¡å¼: ç»¼åˆç›‘æ§\n");
    printf("===============================\n\n");
    
    // é…ç½®å‚æ•°
    @refresh_interval = 2;      // åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰
    @history_size = 30;         // å†å²æ•°æ®ä¿ç•™ï¼ˆç§’ï¼‰
    @alert_thresholds.cpu = 80; // CPUå‘Šè­¦é˜ˆå€¼ï¼ˆ%ï¼‰
    @alert_thresholds.mem = 90; // å†…å­˜å‘Šè­¦é˜ˆå€¼ï¼ˆ%ï¼‰
    @alert_thresholds.io = 100; // I/Oå‘Šè­¦é˜ˆå€¼ï¼ˆMB/sï¼‰
    @alert_thresholds.net = 50; // ç½‘ç»œå‘Šè­¦é˜ˆå€¼ï¼ˆMB/sï¼‰
    
    // åˆå§‹åŒ–æ•°æ®ç»“æ„
    @start_time = nsecs;
    @alerts = 0;
    
    printf("åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ç›‘æ§...\n");
    sleep(1);
}

// ========== 1. CPUç›‘æ§ ==========

// CPUä½¿ç”¨ç‡è·Ÿè¸ª
tracepoint:sched:sched_stat_runtime
{
    $cpu_time = args->runtime;
    $comm = comm;
    
    // æŒ‰è¿›ç¨‹ç»Ÿè®¡CPUæ—¶é—´
    @cpu_by_process[$comm] = sum($cpu_time);
    
    // æ€»CPUæ—¶é—´
    @total_cpu_time = sum($cpu_time);
    
    // CPUæ—¶é—´åˆ†å¸ƒï¼ˆæŒ‰CPUæ ¸å¿ƒï¼‰
    @cpu_by_core[cpu] = sum($cpu_time);
}

// ä¸Šä¸‹æ–‡åˆ‡æ¢è·Ÿè¸ª
tracepoint:sched:sched_switch
{
    @context_switches = count();
    @switch_by_process[args->prev_comm] = count();
}

// ========== 2. å†…å­˜ç›‘æ§ ==========

// é¡µé¢åˆ†é…è·Ÿè¸ª
tracepoint:kmem:mm_page_alloc
{
    $order = args->order;
    $pages = 1 << $order;  // è®¡ç®—åˆ†é…çš„é¡µé¢æ•°
    
    @page_allocations = count();
    @pages_allocated = sum($pages);
    @alloc_by_process[comm] = sum($pages);
    
    // æŒ‰åˆ†é…å¤§å°ç»Ÿè®¡
    @alloc_by_size[$order] = count();
}

// é¡µé¢é‡Šæ”¾è·Ÿè¸ª
tracepoint:kmem:mm_page_free
{
    $order = args->order;
    $pages = 1 << $order;
    
    @page_frees = count();
    @pages_freed = sum($pages);
}

// å†…å­˜å‹ç¼©è·Ÿè¸ª
tracepoint:vmscan:mm_vmscan_direct_reclaim_begin
{
    @direct_reclaims = count();
}

tracepoint:vmscan:mm_vmscan_direct_reclaim_end
{
    if (@direct_reclaims > 0) {
        @direct_reclaims--;
    }
}

// ========== 3. ç£ç›˜I/Oç›‘æ§ ==========

// ç£ç›˜I/Oè¯·æ±‚
tracepoint:block:block_rq_issue
{
    $sector = args->sector;
    $bytes = args->bytes;
    $comm = comm;
    
    // è®°å½•å¼€å§‹æ—¶é—´
    @io_start_time[$sector] = nsecs;
    @io_process[$sector] = $comm;
    @io_size[$sector] = $bytes;
    
    // ç»Ÿè®¡
    @io_requests = count();
    @io_bytes = sum($bytes);
    @io_by_process[$comm] = sum($bytes);
    
    // æŒ‰è®¾å¤‡ç»Ÿè®¡
    @io_by_device[args->dev] = sum($bytes);
}

// ç£ç›˜I/Oå®Œæˆ
tracepoint:block:block_rq_complete
{
    $sector = args->sector;
    
    if (@io_start_time[$sector]) {
        // è®¡ç®—å»¶è¿Ÿ
        $latency = nsecs - @io_start_time[$sector];
        $process = @io_process[$sector];
        $size = @io_size[$sector];
        
        // å»¶è¿Ÿç»Ÿè®¡
        @io_latency = hist($latency / 1000);  // è½¬æ¢ä¸ºå¾®ç§’
        
        // æŒ‰è¿›ç¨‹ç»Ÿè®¡å»¶è¿Ÿ
        @io_latency_by_process[$process] = avg($latency);
        
        // æ¸…ç†
        delete(@io_start_time[$sector]);
        delete(@io_process[$sector]);
        delete(@io_size[$sector]);
    }
}

// ========== 4. ç½‘ç»œç›‘æ§ ==========

// ç½‘ç»œå‘é€
tracepoint:net:net_dev_queue
{
    $len = args->len;
    $comm = comm;
    
    @net_tx_packets = count();
    @net_tx_bytes = sum($len);
    @net_tx_by_process[$comm] = sum($len);
    
    // æŒ‰åè®®ç»Ÿè®¡
    @net_tx_by_protocol[args->protocol] = sum($len);
}

// ç½‘ç»œæ¥æ”¶
tracepoint:net:netif_receive_skb
{
    $len = args->len;
    $comm = comm;
    
    @net_rx_packets = count();
    @net_rx_bytes = sum($len);
    @net_rx_by_process[$comm] = sum($len);
}

// TCPè¿æ¥è·Ÿè¸ª
tracepoint:tcp:tcp_connect
{
    @tcp_connects = count();
    @tcp_connect_by_process[comm] = count();
}

// ========== 5. æ–‡ä»¶ç³»ç»Ÿç›‘æ§ ==========

// æ–‡ä»¶æ‰“å¼€è·Ÿè¸ª
tracepoint:syscalls:sys_enter_open,
tracepoint:syscalls:sys_enter_openat
{
    $filename = str(args->filename);
    $comm = comm;
    
    @file_opens = count();
    @file_opens_by_process[$comm] = count();
    
    // è®°å½•çƒ­é—¨æ–‡ä»¶
    @hot_files[$filename] = count();
}

// æ–‡ä»¶è¯»å†™è·Ÿè¸ª
tracepoint:syscalls:sys_enter_read
{
    @file_reads = count();
    @read_bytes = sum(args->count);
}

tracepoint:syscalls:sys_enter_write
{
    @file_writes = count();
    @write_bytes = sum(args->count);
}

// ========== 6. è¿›ç¨‹ç›‘æ§ ==========

// è¿›ç¨‹åˆ›å»º
tracepoint:sched:sched_process_fork
{
    @process_forks = count();
    @forks_by_process[args->parent_comm] = count();
}

// è¿›ç¨‹é€€å‡º
tracepoint:sched:sched_process_exit
{
    @process_exits = count();
}

// ========== 7. ä¸­æ–­ç›‘æ§ ==========

// ç¡¬ä»¶ä¸­æ–­
tracepoint:irq:irq_handler_entry
{
    @irqs = count();
    @irqs_by_number[args->irq] = count();
}

// è½¯ä¸­æ–­
tracepoint:irq:softirq_entry
{
    @softirqs = count();
    @softirqs_by_vec[args->vec] = count();
}

// ========== ä¸»æ˜¾ç¤ºå¾ªç¯ ==========

interval:s:@refresh_interval
{
    $current_time = nsecs;
    $elapsed_seconds = ($current_time - @start_time) / 1000000000;
    
    // æ¸…å±å¹¶æ˜¾ç¤ºæ ‡é¢˜
    printf("\033[2J\033[H");
    printf("âš¡ eBPF é«˜çº§ç³»ç»Ÿè·Ÿè¸ªä»ªè¡¨æ¿ | è¿è¡Œæ—¶é—´: %dç§’\n", $elapsed_seconds);
    printf("æ›´æ–°æ—¶é—´: %s | å‘Šè­¦: %d\n", 
           strftime("%H:%M:%S", $current_time), 
           @alerts);
    printf("===========================================================\n\n");
    
    // 1. ç³»ç»Ÿæ¦‚è§ˆ
    printf("ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ:\n");
    printf("------------\n");
    
    // CPUä½¿ç”¨ç‡
    $total_cpu_ms = @total_cpu_time / 1000000;
    $cpu_percent = ($total_cpu_ms / (@refresh_interval * 1000)) * 100 * 100; // ä¼°ç®—ç™¾åˆ†æ¯”
    
    // å†…å­˜ä½¿ç”¨
    $mem_pages = @pages_allocated - @pages_freed;
    $mem_mb = $mem_pages * 4 / 1024;  // æ¯é¡µ4KBï¼Œè½¬æ¢ä¸ºMB
    
    // I/Oååé‡
    $io_mb = @io_bytes / 1024 / 1024;
    $io_mbps = $io_mb / @refresh_interval;
    
    // ç½‘ç»œååé‡
    $net_mb = (@net_tx_bytes + @net_rx_bytes) / 1024 / 1024;
    $net_mbps = $net_mb / @refresh_interval;
    
    printf("CPU: %6.1f%% | å†…å­˜: %6.1f MB | I/O: %6.1f MB/s | ç½‘ç»œ: %6.1f MB/s\n\n",
           $cpu_percent > 100 ? 100 : $cpu_percent,
           $mem_mb,
           $io_mbps,
           $net_mbps);
    
    // 2. è¿›ç¨‹èµ„æºä½¿ç”¨æ’è¡Œ
    printf("ğŸƒ è¿›ç¨‹èµ„æºä½¿ç”¨ (Top 5):\n");
    printf("-----------------------\n");
    printf("%-20s %8s %8s %8s %8s\n", 
           "è¿›ç¨‹", "CPU(ms)", "å†…å­˜(MB)", "I/O(MB)", "ç½‘ç»œ(MB)");
    printf("%-20s %8s %8s %8s %8s\n",
           "----", "-------", "--------", "-------", "--------");
    
    $i = 0;
    foreach ([$process, $cpu] in @cpu_by_process limit 5) {
        $cpu_ms = $cpu / 1000000;
        $mem_pages = @alloc_by_process[$process] - @freed_by_process[$process];
        $mem_mb = $mem_pages * 4 / 1024;
        $io_mb = @io_by_process[$process] / 1024 / 1024;
        $net_mb = (@net_tx_by_process[$process] + @net_rx_by_process[$process]) / 1024 / 1024;
        
        printf("%-20s %8.1f %8.1f %8.1f %8.1f\n",
               $process, $cpu_ms, $mem_mb, $io_mb, $net_mb);
        $i++;
    }
    printf("\n");
    
    // 3. ç£ç›˜I/Oè¯¦æƒ…
    printf("ğŸ’¾ ç£ç›˜I/Oç»Ÿè®¡:\n");
    printf("--------------\n");
    printf("è¯·æ±‚æ•°: %d | ååé‡: %.1f MB/s | å¹³å‡å»¶è¿Ÿ: %.1f Î¼s\n\n",
           @io_requests,
           $io_mbps,
           avg(@io_latency));
    
    // 4. ç½‘ç»œè¯¦æƒ…
    printf("ğŸŒ ç½‘ç»œç»Ÿè®¡:\n");
    printf("-----------\n");
    printf("å‘é€: %d åŒ…, %.1f MB/s | æ¥æ”¶: %d åŒ…, %.1f MB/s | TCPè¿æ¥: %d\n\n",
           @net_tx_packets,
           @net_tx_bytes / 1024 / 1024 / @refresh_interval,
           @net_rx_packets,
           @net_rx_bytes / 1024 / 1024 / @refresh_interval,
           @tcp_connects);
    
    // 5. æ–‡ä»¶ç³»ç»Ÿæ´»åŠ¨
    printf("ğŸ“ æ–‡ä»¶ç³»ç»Ÿæ´»åŠ¨:\n");
    printf("---------------\n");
    printf("æ‰“å¼€: %d | è¯»å–: %d | å†™å…¥: %d | çƒ­é—¨æ–‡ä»¶: %d\n\n",
           @file_opens,
           @file_reads,
           @file_writes,
           count(@hot_files));
    
    // 6. ä¸­æ–­ç»Ÿè®¡
    printf("ğŸ”§ ä¸­æ–­ç»Ÿè®¡:\n");
    printf("-----------\n");
    printf("ç¡¬ä»¶ä¸­æ–­: %d | è½¯ä¸­æ–­: %d | ä¸Šä¸‹æ–‡åˆ‡æ¢: %d\n\n",
           @irqs,
           @softirqs,
           @context_switches);
    
    // 7. è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ
    printf("ğŸ”„ è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ:\n");
    printf("---------------\n");
    printf("åˆ›å»º: %d | é€€å‡º: %d | å­˜æ´»è¿›ç¨‹: %d\n\n",
           @process_forks,
           @process_exits,
           @process_forks - @process_exits);
    
    // 8. å‘Šè­¦æ£€æŸ¥
    printf("ğŸš¨ å‘Šè­¦æ£€æŸ¥:\n");
    printf("-----------\n");
    
    $alerts_found = 0;
    
    // CPUå‘Šè­¦
    if ($cpu_percent > @alert_thresholds.cpu) {
        printf("âš   CPUä½¿ç”¨ç‡è¿‡é«˜: %.1f%% (é˜ˆå€¼: %d%%)\n", 
               $cpu_percent, @alert_thresholds.cpu);
        $alerts_found = 1;
    }
    
    // å†…å­˜å‘Šè­¦
    if ($mem_mb > @alert_thresholds.mem * 1024) {  // è½¬æ¢ä¸ºMB
        printf("âš   å†…å­˜ä½¿ç”¨è¿‡é«˜: %.1f MB (é˜ˆå€¼: %d MB)\n",
               $mem_mb, @alert_thresholds.mem * 1024);
        $alerts_found = 1;
    }
    
    // I/Oå‘Šè­¦
    if ($io_mbps > @alert_thresholds.io) {
        printf("âš   ç£ç›˜I/Oè¿‡é«˜: %.1f MB/s (é˜ˆå€¼: %d MB/s)\n",
               $io_mbps, @alert_thresholds.io);
        $alerts_found = 1;
    }
    
    // ç½‘ç»œå‘Šè­¦
    if ($net_mbps > @alert_thresholds.net) {
        printf("âš   ç½‘ç»œæµé‡è¿‡é«˜: %.1f MB/s (é˜ˆå€¼: %d MB/s)\n",
               $net_mbps, @alert_thresholds.net);
        $alerts_found = 1;
    }
    
    if (!$alerts_found) {
        printf("âœ… æ‰€æœ‰ç³»ç»ŸæŒ‡æ ‡æ­£å¸¸\n");
    }
    
    // 9. å†å²è¶‹åŠ¿ï¼ˆç®€åŒ–çš„ASCIIå›¾è¡¨ï¼‰
    if ($elapsed_seconds % 10 == 0) {
        printf("\nğŸ“ˆ CPUä½¿ç”¨ç‡è¶‹åŠ¿ (æœ€è¿‘%dç§’):\n", @history_size);
        
        // å­˜å‚¨å½“å‰æ•°æ®ç‚¹
        $time_index = $elapsed_seconds % @history_size;
        @cpu_history[$time_index] = $cpu_percent;
        
        // ç»˜åˆ¶ç®€åŒ–çš„ASCIIå›¾è¡¨
        for ($i = 0; $i < @history_size; $i++) {
            $value = @cpu_history[($time_index - $i) % @history_size];
            if ($value == 0) {
                printf("_");
            } else if ($value < 25) {
                printf("â–");
            } else if ($value < 50) {
                printf("â–‚");
            } else if ($value < 75) {
                printf("â–ƒ");
            } else {
                printf("â–…");
            }
        }
        printf(" %.1f%%\n", $cpu_percent);
    }
    
    printf("\n===========================================================\n");
    printf("æŒ‰ Ctrl+C åœæ­¢ç›‘æ§ | åˆ·æ–°é—´éš”: %dç§’\n", @refresh_interval);
    
    // é‡ç½®è®¡æ•°å™¨ï¼ˆä¿ç•™å†å²æ•°æ®ï¼‰
    clear(@total_cpu_time);
    clear(@io_bytes);
    clear(@net_tx_bytes);
    clear(@net_rx_bytes);
    clear(@file_opens);
    clear(@file_reads);
    clear(@file_writes);
    
    // æ¸…ç†è¿›ç¨‹ç»Ÿè®¡ï¼ˆä¿ç•™çƒ­é—¨è¿›ç¨‹ï¼‰
    foreach ([$process, $value] in @cpu_by_process) {
        if ($value < 1000000) {  // å°äº1msçš„å¿½ç•¥
            delete(@cpu_by_process[$process]);
        }
    }
    
    // æ¸…ç†æ—§æ•°æ®
    $old_time = $current_time - (@history_size * 1000000000);
    // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ ¹æ®æ—¶é—´æˆ³æ¸…ç†
    
    // æ›´æ–°å‘Šè­¦è®¡æ•°
    if ($alerts_found) {
        @alerts++;
    }
}

// ========== æ¸…ç†å’Œæ€»ç»“ ==========

END
{
    $total_time = (nsecs - @start_time) / 1000000000;
    
    printf("\n\n===========================================================\n");
    printf("ğŸ“‹ ç›‘æ§ç»“æŸ - è¿è¡Œæ—¶é—´: %.1f ç§’\n", $total_time);
    printf("===========================================================\n\n");
    
    // æœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š
    printf("æœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š:\n");
    printf("============\n\n");
    
    // 1. æ€»ä½“ç»Ÿè®¡
    printf("1. æ€»ä½“ç»Ÿè®¡:\n");
    printf("   CPUæ—¶é—´: %.1f ç§’\n", @total_cpu_time / 1000000000);
    printf("   å†…å­˜åˆ†é…: %d é¡µ (%.1f MB)\n", @pages_allocated, @pages_allocated * 4 / 1024);
    printf("   ç£ç›˜I/O: %.1f MB\n", @io_bytes / 1024 / 1024);
    printf("   ç½‘ç»œæµé‡: %.1f MB\n", (@net_tx_bytes + @net_rx_bytes) / 1024 / 1024);
    printf("   æ–‡ä»¶æ“ä½œ: %d æ¬¡\n", @file_opens + @file_reads + @file_writes);
    printf("   ä¸Šä¸‹æ–‡åˆ‡æ¢: %d æ¬¡\n", @context_switches);
    printf("   ä¸­æ–­å¤„ç†: %d æ¬¡\n", @irqs + @softirqs);
    
    // 2. Topè¿›ç¨‹æŠ¥å‘Š
    printf("\n2. Top è¿›ç¨‹ (æŒ‰CPUæ—¶é—´):\n");
    printf("   %-20s %12s %12s\n", "è¿›ç¨‹", "CPUæ—¶é—´(s)", "å æ¯”(%)");
    printf("   %-20s %12s %12s\n", "----", "---------", "------");
    
    $i = 0;
    foreach ([$process, $cpu] in @cpu_by_process limit 10) {
        $cpu_seconds = $cpu / 1000000000;
        $percentage = ($cpu_seconds / $total_time) * 100;
        printf("   %-20s %12.2f %12.1f\n", 
               $process, $cpu_seconds, $percentage);
        $i++;
    }
    
    // 3. ç£ç›˜I/OæŠ¥å‘Š
    printf("\n3. ç£ç›˜I/Oå»¶è¿Ÿåˆ†å¸ƒ (å¾®ç§’):\n");
    print(@io_latency);
    
    // 4. å‘Šè­¦æ€»ç»“
    printf("\n4. å‘Šè­¦ç»Ÿè®¡:\n");
    printf("   æ€»å‘Šè­¦æ¬¡æ•°: %d\n", @alerts);
    printf("   å¹³å‡å‘Šè­¦é¢‘ç‡: %.2f æ¬¡/åˆ†é’Ÿ\n", @alerts / ($total_time / 60));
    
    // 5. æ€§èƒ½å»ºè®®
    printf("\n5. æ€§èƒ½å»ºè®®:\n");
    
    $avg_cpu = (@total_cpu_time / 1000000000) / $total_time * 100;
    if ($avg_cpu > 70) {
        printf("   âš   CPUä½¿ç”¨ç‡è¾ƒé«˜ (%.1f%%)ï¼Œå»ºè®®æ£€æŸ¥CPUå¯†é›†å‹è¿›ç¨‹\n", $avg_cpu);
    }
    
    $avg_io = @io_bytes / 1024 / 1024 / $total_time;
    if ($avg_io > 50) {
        printf("   âš   ç£ç›˜I/Oè¾ƒé«˜ (%.1f MB/s)ï¼Œå»ºè®®ä¼˜åŒ–ç£ç›˜è®¿é—®\n", $avg_io);
    }
    
    $avg_net = (@net_tx_bytes + @net_rx_bytes) / 1024 / 1024 / $total_time;
    if ($avg_net > 20) {
        printf("   âš   ç½‘ç»œæµé‡è¾ƒé«˜ (%.1f MB/s)ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œåº”ç”¨\n", $avg_net);
    }
    
    if ($avg_cpu < 30 && $avg_io < 10 && $avg_net < 5) {
        printf("   âœ… ç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œèµ„æºä½¿ç”¨åœ¨åˆç†èŒƒå›´å†…\n");
    }
    
    printf("\n===========================================================\n");
    printf("ç›‘æ§ç»“æŸæ—¶é—´: %s\n", strftime("%Y-%m-%d %H:%M:%S", nsecs));
    printf("æ„Ÿè°¢ä½¿ç”¨ eBPF é«˜çº§è·Ÿè¸ªç³»ç»Ÿï¼\n");
    printf("===========================================================\n");
}